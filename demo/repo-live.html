<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>REPO PROTOCOL - Live</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0e0e0e;overflow:hidden;font-family:'Consolas','SF Mono','Monaco','Menlo',monospace;color:#999;font-size:10px}
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#2a2a2a}
button{font-family:inherit;transition:all 0.1s;border-radius:0}
button:hover:not(:disabled){filter:brightness(1.25)}
button:active:not(:disabled){filter:brightness(0.85)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.35}}
@keyframes spin{to{transform:rotate(360deg)}}
.bk{animation:blink 1.2s infinite}
.spin{animation:spin 1s linear infinite;display:inline-block}
table{width:100%;border-collapse:collapse}
th,td{text-align:left;padding:3px 6px;font-size:10px;border-bottom:1px solid #1a1a1a}
th{color:#555;font-weight:600;text-transform:uppercase;font-size:9px;letter-spacing:0.08em}
.r{color:#c44}.g{color:#4a4}.y{color:#a90}.b{color:#58a}.p{color:#86c}.w{color:#ccc}.d{color:#444}
</style>
</head>
<body>
<div id="root"></div>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
<script type="text/babel">
const{useState,useCallback,useEffect}=React;
const{ethers}=window;

const ADDR = {
  SERVICER:   "0x46AEeAB1C393485FfFcb1B32c91A4396E1F7c94F",
  REPO_TOKEN: "0x213268B2562738167F0EC947b7e1488732030004",
  USDC:       "0x762427e83F146E755433b9185dD15810963D4beC",
  USYC:       "0x59C0B081373F7caA83b82a1267b7F66b372002a5",
  USTB:       "0x8F2fd22d2568B1d637892F7b6F8d32313d975491",
  PRICE_FEED: "0xb3eEc424E508299C8DE140b94C990878b36EAbaD",
  YIELD_DIST: "0x094dC49cE0b36DFCA934DF3Bf20E5e8F6fd4c53d",
  BORROWER:   "0x0D781453255A7Dbdf7F431CbCB956733173898b5",
  LENDER:     "0x3FB2d86389bea9f673F6Fc9d9FD4AE549A2f2eB1",
  CHARLIE:    "0x6F217c0bA23D54330E38A9Ee917455659e4d597d",
};

const ABI = {
  SERVICER: [
    "function proposeRepo(address,uint256,address,uint256,uint256,uint256,uint256) returns (uint256)",
    "function proposeRepoWithRT(address,uint256,uint256,uint256,uint256,uint256) returns (uint256)",
    "function acceptRepo(uint256)",
    "function forceMaturity(uint256)",
    "function settleRepo(uint256)",
    "function checkMargin(uint256)",
    "function topUpCollateral(uint256,uint256)",
    "function liquidate(uint256)",
    "function forceLiquidate(uint256)",
    "function requestSubstitution(uint256,address,uint256)",
    "function approveSubstitution(uint256)",
    "function calculateSettlement(uint256) view returns (uint256,uint256,uint256)",
    "function calculateRepoTokenValue(uint256) view returns (uint256)",
    "function getRepo(uint256) view returns (tuple(uint256 id,address borrower,address lender,address cashToken,uint256 cashAmount,uint8 collateralType,address collateralToken,uint256 collateralAmount,uint256 collateralTokenId,uint256 haircutBps,uint256 repoRateBps,uint256 termSeconds,uint256 failPenaltyBps,uint256 proposedAt,uint256 startTime,uint256 maturityTime,uint8 state,uint256 marginCallDeadline,uint256 accumulatedYield))",
    "function getRepoState(uint256) view returns (uint8)",
    "function getCollateralValue(uint256) view returns (uint256)",
    "function getRequiredCollateralValue(uint256) view returns (uint256)",
    "function nextRepoId() view returns (uint256)",
    "function getRehypoRepo(uint256) view returns (uint256)",
  ],
  ERC20: [
    "function balanceOf(address) view returns (uint256)",
    "function approve(address,uint256) returns (bool)",
    "function allowance(address,address) view returns (uint256)",
    "function mint(address,uint256)",
  ],
  REPO_TOKEN: [
    "function ownerOf(uint256) view returns (address)",
    "function balanceOf(address) view returns (uint256)",
  ],
  PRICE_FEED: [
    "function setPrice(address,uint256)",
    "function getPrice(address) view returns (uint256)",
  ],
  YIELD_DIST: [
    "function distributeYield(uint256,uint256)",
  ],
};

const STATES=["PROPOSED","ACTIVE","MARGIN_CALLED","MATURED","SETTLED","DEFAULTED","CANCELLED"];
const stc=s=>({"PROPOSED":"y","ACTIVE":"g","MARGIN_CALLED":"r","MATURED":"y","SETTLED":"d","DEFAULTED":"r"}[s]||"d");
const D6=1000000n;
const fmt=v=>{if(typeof v==='bigint')v=Number(v)/1e6;return Number(v).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})};
const fmtK=v=>{if(typeof v==='bigint')v=Number(v)/1e6;return v>=1e6?`${(v/1e6).toFixed(1)}M`:v>=1000?`${(v/1000).toFixed(0)}K`:`${v}`};
const short=a=>a?`${a.slice(0,6)}..${a.slice(-4)}`:"--";
const T=()=>[new Date().getHours(),new Date().getMinutes(),new Date().getSeconds()].map(v=>String(v).padStart(2,'0')).join(':');

const Btn=({children,onClick,disabled,active,warn,loading,style:s})=>(
  <button onClick={onClick} disabled={disabled||loading} className={active&&!loading?"bk":""} style={{
    padding:"3px 8px",fontSize:"9.5px",fontWeight:600,
    background:disabled?"#151515":loading?"#1a1a00":warn?"#2a1111":active?"#112211":"#1e1e1e",
    color:disabled?"#2a2a2a":loading?"#a90":warn?"#c44":active?"#4a4":"#777",
    border:`1px solid ${disabled?"#1a1a1a":loading?"#333300":warn?"#3a1111":active?"#1a3a1a":"#2a2a2a"}`,
    cursor:disabled||loading?"default":"pointer",letterSpacing:"0.03em",...s
  }}>{loading?<><span className="spin">*</span> TX...</>:children}</button>
);

const Log=({time,text,c=""})=>(
  <div style={{display:"flex",gap:6,padding:"1.5px 0",fontSize:10,lineHeight:1.4,borderBottom:"1px solid #111"}}>
    <span style={{color:"#333",flexShrink:0,fontVariantNumeric:"tabular-nums"}}>{time}</span>
    <span className={c}>{text}</span>
  </div>
);

function App(){
  const[wallet,setWallet]=useState(null);
  const[signer,setSigner]=useState(null);
  const[provider,setProvider]=useState(null);
  const[loading,setLoading]=useState("");
  const[ef,setEf]=useState([]);
  const[hint,setHint]=useState("Connect wallet to begin");
  const[act,setAct]=useState(1);

  // Act 1 state
  const[repo1Id,setRepo1Id]=useState(0);
  const[repo1,setRepo1]=useState(null);
  const[repo1State,setRepo1State]=useState("");

  // Act 2 state
  const[repo2Id,setRepo2Id]=useState(0);
  const[repo2,setRepo2]=useState(null);
  const[repo2State,setRepo2State]=useState("");

  // Balances
  const[bBal,setBBal]=useState({usdc:0n,usyc:0n,ustb:0n});
  const[lBal,setLBal]=useState({usdc:0n,usyc:0n,ustb:0n});
  const[cBal,setCBal]=useState({usdc:0n});
  const[borrowerAddr,setBorrowerAddr]=useState("");
  const[lenderAddr,setLenderAddr]=useState("");
  const[charlieAddr,setCharlieAddr]=useState("");
  const[usycPrice,setUsycPrice]=useState(1.0);
  const[colValue,setColValue]=useState(0n);
  const[reqValue,setReqValue]=useState(0n);
  const[settlement1,setSettlement1]=useState(null);
  const[rtHolder,setRtHolder]=useState("");
  const[rtValue,setRtValue]=useState(0n);
  const[colValue2,setColValue2]=useState(0n);
  const[reqValue2,setReqValue2]=useState(0n);

  const ae=useCallback((t,c="")=>setEf(p=>[{t,c,ts:T(),id:Math.random()},...p].slice(0,50)),[]);

  // Connect
  const connect=async()=>{
    if(!window.ethereum){alert("Install MetaMask");return}
    try{
      const p=new ethers.BrowserProvider(window.ethereum);
      await p.send("eth_requestAccounts",[]);
      const origFee=p.getFeeData.bind(p);
      p.getFeeData=async()=>{const f=await origFee();const b=f.maxFeePerGas||0n;return{maxFeePerGas:b*3n/2n+1000000n,maxPriorityFeePerGas:f.maxPriorityFeePerGas||1000000n,gasPrice:b*3n/2n+1000000n}};
      const s=await p.getSigner();
      const addr=await s.getAddress();
      setProvider(p);setSigner(s);setWallet(addr);
      ae(`WALLET CONNECTED: ${short(addr)}`,"g");
      setHint("BORROWER >> NEW REPO");
    }catch(e){ae(`CONNECT ERROR: ${e.message}`,"r")}
  };

  useEffect(()=>{
    if(!window.ethereum)return;
    const h=accounts=>{if(accounts.length>0){setWallet(accounts[0]);ae(`WALLET SWITCHED: ${short(accounts[0])}`,"b")}};
    window.ethereum.on('accountsChanged',h);
    return()=>window.ethereum.removeListener('accountsChanged',h);
  },[]);

  useEffect(()=>{
    if(!provider||!wallet)return;
    (async()=>{setSigner(await provider.getSigner())})();
  },[wallet,provider]);

  // Contracts
  const getS=()=>new ethers.Contract(ADDR.SERVICER,ABI.SERVICER,signer);
  const getERC20=a=>new ethers.Contract(a,ABI.ERC20,signer);
  const getPF=()=>new ethers.Contract(ADDR.PRICE_FEED,ABI.PRICE_FEED,signer);
  const getYD=()=>new ethers.Contract(ADDR.YIELD_DIST,ABI.YIELD_DIST,signer);
  const getRT=()=>new ethers.Contract(ADDR.REPO_TOKEN,ABI.REPO_TOKEN,signer);
  const G=async()=>{const f=await provider.getFeeData();const b=f.maxFeePerGas||20000000n;return{maxFeePerGas:b*5n,maxPriorityFeePerGas:5000000n}};

  const ensureApproval=async(tokenAddr,amount)=>{
    const token=getERC20(tokenAddr);
    const allow=await token.allowance(wallet,ADDR.SERVICER);
    if(allow<amount){
      ae(`APPROVING ${short(tokenAddr)}...`,"d");
      const tx=await token.approve(ADDR.SERVICER,ethers.MaxUint256,await G());
      await tx.wait();ae("APPROVED","g");
    }
  };

  // Refresh balances
  const refreshBal=async(s)=>{
    if(!s)return;
    try{
      const usdc=new ethers.Contract(ADDR.USDC,ABI.ERC20,s);
      const usyc=new ethers.Contract(ADDR.USYC,ABI.ERC20,s);
      const ustb=new ethers.Contract(ADDR.USTB,ABI.ERC20,s);
      if(ADDR.BORROWER){setBorrowerAddr(ADDR.BORROWER);setBBal({usdc:await usdc.balanceOf(ADDR.BORROWER),usyc:await usyc.balanceOf(ADDR.BORROWER),ustb:await ustb.balanceOf(ADDR.BORROWER)})}
      if(ADDR.LENDER){setLenderAddr(ADDR.LENDER);setLBal({usdc:await usdc.balanceOf(ADDR.LENDER),usyc:await usyc.balanceOf(ADDR.LENDER),ustb:await ustb.balanceOf(ADDR.LENDER)})}
      if(ADDR.CHARLIE){setCharlieAddr(ADDR.CHARLIE);setCBal({usdc:await usdc.balanceOf(ADDR.CHARLIE)})}
      try{const pf=new ethers.Contract(ADDR.PRICE_FEED,ABI.PRICE_FEED,s);setUsycPrice(Number(await pf.getPrice(ADDR.USYC))/1e6)}catch(e){}
    }catch(e){console.error("bal err",e)}
  };

  // Refresh repo state
  const refreshRepo=async(rid,setter,stateSetter)=>{
    if(!signer||!rid)return;
    try{
      const s=getS();
      const r=await s.getRepo(rid);
      setter(r);stateSetter(STATES[Number(r.state)]||"UNKNOWN");
    }catch(e){}
  };

  const refreshAll=async()=>{
    if(!signer)return;
    await refreshBal(signer);
    if(repo1Id)await refreshRepo(repo1Id,setRepo1,setRepo1State);
    if(repo2Id)await refreshRepo(repo2Id,setRepo2,setRepo2State);
    // Collateral values
    try{const s=getS();
      if(repo1Id){setColValue(await s.getCollateralValue(repo1Id));setReqValue(await s.getRequiredCollateralValue(repo1Id))}
      if(repo2Id){setColValue2(await s.getCollateralValue(repo2Id));setReqValue2(await s.getRequiredCollateralValue(repo2Id))}
    }catch(e){}
    // RT value for repo1
    try{if(repo1Id){const s=getS();setRtValue(await s.calculateRepoTokenValue(repo1Id))}}catch(e){}
    // RT holder
    try{if(repo1Id){const rt=getRT();setRtHolder(await rt.ownerOf(repo1Id))}}catch(e){setRtHolder("")}
    // Settlement
    try{if(repo1Id&&(repo1State==="MATURED"||repo1State==="SETTLED")){const s=getS();const[i,m,n]=await s.calculateSettlement(repo1Id);setSettlement1({int:i,mfg:m,net:n})}}catch(e){}
  };

  useEffect(()=>{if(!signer)return;refreshAll();const iv=setInterval(refreshAll,5000);return()=>clearInterval(iv)},[signer,repo1Id,repo2Id]);

  // Wrap
  const wrap=async(name,fn)=>{setLoading(name);try{await fn();await refreshAll()}catch(e){ae(`ERROR: ${e.reason||e.message}`,"r")}setLoading("")};

  // ═══ ACT 1 ACTIONS ═══
  const doPropose=()=>wrap("propose",async()=>{
    await ensureApproval(ADDR.USYC,105000n*D6);
    const s=getS();ae("PROPOSE: 105K USYC / 100K USDC / 4.50% / 30D ...","y");
    const tx=await s.proposeRepo(ADDR.USDC,100000n*D6,ADDR.USYC,105000n*D6,500,450,2592000,await G());
    const rc=await tx.wait();
    const ev=rc.logs.map(l=>{try{return s.interface.parseLog(l)}catch(e){return null}}).find(e=>e&&e.name==="RepoProposed");
    const rid=ev?Number(ev.args.repoId):1;
    setRepo1Id(rid);ae(`PROPOSED #${rid} tx=${short(tx.hash)}`,"g");
    setHint("Switch to LENDER >> ACCEPT #"+rid);
  });

  const doAccept=()=>wrap("accept",async()=>{
    await ensureApproval(ADDR.USDC,100000n*D6);
    const s=getS();ae(`ACCEPT #${repo1Id} ...`,"b");
    const tx=await s.acceptRepo(repo1Id,await G());await tx.wait();
    ae(`ACCEPTED #${repo1Id} - TITLE TRANSFER tx=${short(tx.hash)}`,"g");
    setHint("PROTOCOL >> TRIGGER YIELD");
  });

  const doYield=()=>wrap("yield",async()=>{
    const yd=getYD();ae(`YIELD +520 USDC on #${repo1Id} ...`,"y");
    const tx=await yd.distributeYield(repo1Id,520n*D6,await G());await tx.wait();
    ae(`YIELD DISTRIBUTED tx=${short(tx.hash)}`,"g");setHint("PROTOCOL >> SET PRICE $0.96");
  });

  const doSetPrice=async(price)=>{
    if(!signer)return;setLoading("price");
    try{const pf=getPF();const tx=await pf.setPrice(ADDR.USYC,BigInt(Math.round(price*1e6)),await G());await tx.wait();
      setUsycPrice(price);ae(`PRICE SET: USYC = $${price.toFixed(4)}`,"y");
      if(price<=0.97)setHint("PROTOCOL >> CHECK MARGIN");
    }catch(e){ae(`PRICE ERROR: ${e.reason||e.message}`,"r")}setLoading("")};

  const doCheckMargin=()=>wrap("margin",async()=>{
    const s=getS();ae(`CHECK MARGIN #${repo1Id} ...`,"r");
    const tx=await s.checkMargin(repo1Id,await G());await tx.wait();
    ae(`MARGIN CALL TRIGGERED tx=${short(tx.hash)}`,"r");setHint("Switch to BORROWER >> TOP UP");
  });

  const doTopUp=()=>wrap("topup",async()=>{
    await ensureApproval(ADDR.USYC,5000n*D6);
    const s=getS();ae(`TOP UP +5K USYC on #${repo1Id} ...`,"g");
    const tx=await s.topUpCollateral(repo1Id,5000n*D6,await G());await tx.wait();
    ae(`TOP UP DONE tx=${short(tx.hash)}`,"g");setHint("BORROWER >> SUBSTITUTE");
  });

  const doSubReq=()=>wrap("subreq",async()=>{
    await ensureApproval(ADDR.USTB,108000n*D6);
    const s=getS();ae(`SUB REQUEST: USYC -> 108K USTB on #${repo1Id} ...`,"b");
    const tx=await s.requestSubstitution(repo1Id,ADDR.USTB,108000n*D6,await G());await tx.wait();
    ae(`SUB REQUESTED tx=${short(tx.hash)}`,"g");setHint("Switch to LENDER >> APPROVE SUB");
  });

  const doSubApprove=()=>wrap("subappr",async()=>{
    const colTok=repo1?repo1.collateralToken:ADDR.USYC;
    await ensureApproval(colTok,200000n*D6);
    const s=getS();ae(`APPROVE SUB #${repo1Id} ...`,"b");
    const tx=await s.approveSubstitution(repo1Id,await G());await tx.wait();
    ae(`SUBSTITUTION DONE tx=${short(tx.hash)}`,"g");setHint("PROTOCOL >> ADVANCE TO MATURITY");
  });

  const doMaturity1=()=>wrap("maturity1",async()=>{
    const s=getS();ae(`ADVANCE TO MATURITY #${repo1Id} ...`,"y");
    const tx=await s.forceMaturity(repo1Id,await G());await tx.wait();
    ae(`MATURED (forced) tx=${short(tx.hash)}`,"g");setHint("Switch to BORROWER >> SETTLE");
  });

  const doSettle1=()=>wrap("settle1",async()=>{
    await ensureApproval(ADDR.USDC,200000n*D6);
    const s=getS();ae(`SETTLE #${repo1Id} ...`,"g");
    const tx=await s.settleRepo(repo1Id,await G());await tx.wait();
    ae(`SETTLED #${repo1Id} tx=${short(tx.hash)}`,"g");setHint("ACT 1 COMPLETE >> CONTINUE to ACT 2");
  });

  // ═══ ACT 2 ACTIONS ═══
  const doStartAct2=async()=>{
    setAct(2);
    // Need a new Repo #X for Act 2 base
    ae("=== ACT 2: REHYPOTHECATION ===","p");
    ae("Lender will propose new Repo, then rehypo RT as collateral","d");
    setHint("BORROWER >> NEW REPO (for Act 2 base)");
  };

  const doPropose2=()=>wrap("propose2",async()=>{
    await ensureApproval(ADDR.USYC,105000n*D6);
    const s=getS();ae("PROPOSE: 105K USYC / 100K USDC / 4.50% / 30D ...","y");
    const tx=await s.proposeRepo(ADDR.USDC,100000n*D6,ADDR.USYC,105000n*D6,500,450,2592000,await G());
    const rc=await tx.wait();
    const ev=rc.logs.map(l=>{try{return s.interface.parseLog(l)}catch(e){return null}}).find(e=>e&&e.name==="RepoProposed");
    const rid=ev?Number(ev.args.repoId):repo1Id+1;
    setRepo1Id(rid);ae(`PROPOSED #${rid} tx=${short(tx.hash)}`,"g");
    setHint("Switch to LENDER >> ACCEPT #"+rid);
  });

  const doAccept2=()=>wrap("accept2",async()=>{
    await ensureApproval(ADDR.USDC,100000n*D6);
    const s=getS();ae(`ACCEPT #${repo1Id} ...`,"b");
    const tx=await s.acceptRepo(repo1Id,await G());await tx.wait();
    ae(`ACCEPTED #${repo1Id} tx=${short(tx.hash)}`,"g");
    setHint("Switch to LENDER >> REHYPO (use RT as collateral)");
  });

  const doRehypo=()=>wrap("rehypo",async()=>{
    const s=getS();
    const rtVal=await s.calculateRepoTokenValue(repo1Id);
    ae(`REHYPO: RT#${repo1Id} (val=${fmt(rtVal)}) as collateral for 90K USDC ...`,"p");
    const tx=await s.proposeRepoWithRT(ADDR.USDC,90000n*D6,repo1Id,1000,480,604800,await G());
    const rc=await tx.wait();
    const ev=rc.logs.map(l=>{try{return s.interface.parseLog(l)}catch(e){return null}}).find(e=>e&&e.name==="RepoProposed");
    const rid2=ev?Number(ev.args.repoId):repo1Id+1;
    setRepo2Id(rid2);ae(`REHYPO #${rid2} PROPOSED (col=RT#${repo1Id}) tx=${short(tx.hash)}`,"g");
    ae(`Capital efficiency: 105K USYC -> 100K + 90K = 190K USDC (1.81x)`,"y");
    setHint("Switch to CHARLIE >> ACCEPT REHYPO #"+rid2);
  });

  const doAcceptRehypo=()=>wrap("acceptRehypo",async()=>{
    await ensureApproval(ADDR.USDC,90000n*D6);
    const s=getS();ae(`CHARLIE ACCEPT #${repo2Id} ...`,"b");
    const tx=await s.acceptRepo(repo2Id,await G());await tx.wait();
    ae(`REHYPO #${repo2Id} ACTIVE - RT#${repo1Id} transferred to Charlie tx=${short(tx.hash)}`,"g");
    setHint("PROTOCOL >> ADVANCE REPO #"+repo1Id+" TO MATURITY (triggers cascade)");
  });

  const doMaturity2=()=>wrap("maturity2",async()=>{
    const s=getS();ae(`ADVANCE TO MATURITY #${repo1Id} ...`,"y");
    const tx=await s.forceMaturity(repo1Id,await G());await tx.wait();
    ae(`REPO #${repo1Id} MATURED tx=${short(tx.hash)}`,"g");
    setHint("Switch to BORROWER >> SETTLE #"+repo1Id+" (triggers CASCADE)");
  });

  const doSettle2=()=>wrap("settle2",async()=>{
    await ensureApproval(ADDR.USDC,200000n*D6);
    const s=getS();ae(`SETTLE #${repo1Id} ...`,"g");
    const tx=await s.settleRepo(repo1Id,await G());await tx.wait();
    ae(`SETTLED #${repo1Id} - RT#${repo1Id} BURNED`,"g");
    ae(`CASCADE: REPO #${repo2Id} -> MARGIN CALLED (collateral destroyed)`,"r");
    setHint("PROTOCOL >> FORCE LIQUIDATE #"+repo2Id);
  });

  const doForceLiquidate=()=>wrap("forceLiq",async()=>{
    const s=getS();ae(`FORCE LIQUIDATE #${repo2Id} ...`,"r");
    const tx=await s.forceLiquidate(repo2Id,await G());await tx.wait();
    ae(`REPO #${repo2Id} DEFAULTED tx=${short(tx.hash)}`,"r");
    ae("=== DEMO COMPLETE ===","p");setHint("DEMO COMPLETE - Full repo lifecycle + rehypo + cascade demonstrated");
  });

  // Role detection
  const isBorrower=wallet&&ADDR.BORROWER&&wallet.toLowerCase()===ADDR.BORROWER.toLowerCase();
  const isLender=wallet&&ADDR.LENDER&&wallet.toLowerCase()===ADDR.LENDER.toLowerCase();
  const isCharlie=wallet&&ADDR.CHARLIE&&wallet.toLowerCase()===ADDR.CHARLIE.toLowerCase();
  const role=isBorrower?"BORROWER":isLender?"LENDER":isCharlie?"CHARLIE":"OBSERVER";

  // Load repo
  const[inputId,setInputId]=useState("1");
  const doLoad=async()=>{const rid=parseInt(inputId);if(isNaN(rid)||rid<1)return;setRepo1Id(rid);ae(`LOADED #${rid}`,"g")};

  // Current active repo for display
  const activeId=act===1?repo1Id:repo1Id;
  const activeRepo=act===1?repo1:repo1;
  const activeState=act===1?repo1State:repo1State;
  const colToken=activeRepo?(activeRepo.collateralToken===ADDR.USTB?"USTB":activeRepo.collateralToken===ADDR.REPO_TOKEN?"RT":"USYC"):"USYC";

  // ═══ RENDER ═══
  return(
<div style={{height:"100vh",background:"#0e0e0e",display:"flex",flexDirection:"column",overflow:"hidden"}}>

{/* HEADER */}
<div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 12px",background:"#111",borderBottom:"1px solid #1e1e1e",flexShrink:0}}>
  <div style={{display:"flex",alignItems:"center",gap:12}}>
    <span style={{fontWeight:800,fontSize:11,color:"#ccc",letterSpacing:"0.1em"}}>REPO</span>
    <span className="d" style={{fontSize:9}}>ARBITRUM SEPOLIA</span>
    <span style={{color:"#222"}}>|</span>
    <span style={{fontSize:9,fontWeight:700,color:act===2?"#86c":"#555"}}>ACT {act}{act===2?" - REHYPO":""}</span>
    <span style={{color:"#222"}}>|</span>
    <span style={{fontSize:9,fontWeight:700,color:role==="BORROWER"?"#a90":role==="LENDER"?"#58a":role==="CHARLIE"?"#86c":"#555"}}>{role}</span>
  </div>
  <div style={{display:"flex",alignItems:"center",gap:8}}>
    <span className="d" style={{fontSize:9}}>USYC</span>
    <span style={{fontSize:10,fontWeight:700,color:usycPrice>=1?"#4a4":"#c44"}}>${usycPrice.toFixed(4)}</span>
    {repo1Id>0&&<><span style={{color:"#222"}}>|</span><span className="d" style={{fontSize:9}}>#1={repo1Id}</span><span className={stc(repo1State)} style={{fontSize:9,fontWeight:700}}>{repo1State}</span></>}
    {repo2Id>0&&<><span className="d" style={{fontSize:9}}>#2={repo2Id}</span><span className={stc(repo2State)} style={{fontSize:9,fontWeight:700}}>{repo2State}</span></>}
    <span style={{color:"#222"}}>|</span>
    {wallet?<span style={{fontSize:9,color:"#4a4"}}>{short(wallet)}</span>:<Btn onClick={connect} active>CONNECT</Btn>}
  </div>
</div>

{/* HINT */}
<div style={{padding:"3px 12px",background:"#0a0a0a",borderBottom:"1px solid #1a1a1a",fontSize:9,color:"#58a",letterSpacing:"0.04em"}}>
  {">> "}{hint}
</div>

{/* 3-COL */}
<div style={{flex:1,display:"grid",gridTemplateColumns:"1fr 240px 1fr",overflow:"hidden"}}>

{/* LEFT: BORROWER (Act1) or LENDER-as-borrower (Act2) */}
<div style={{borderRight:"1px solid #1a1a1a",display:"flex",flexDirection:"column",overflow:"hidden"}}>
  <div style={{padding:"4px 10px",background:"#111",borderBottom:"1px solid #1a1a1a",display:"flex",justifyContent:"space-between"}}>
    <span style={{fontWeight:700,fontSize:10,color:act===1?"#a90":"#58a"}}>{act===1?"BORROWER (Alpha)":"LENDER (Bravo) - Rehypo"}</span>
    <span className="d" style={{fontSize:9}}>{short(act===1?borrowerAddr:lenderAddr)}</span>
  </div>
  <div style={{display:"flex",borderBottom:"1px solid #1a1a1a"}}>
    <div style={{flex:1,padding:"4px 10px",borderRight:"1px solid #1a1a1a"}}>
      <div style={{fontSize:8,letterSpacing:"0.1em"}} className="d">USDC</div>
      <div style={{fontSize:13,fontWeight:700}} className="g">{fmt(act===1?bBal.usdc:lBal.usdc)}</div>
    </div>
    <div style={{flex:1,padding:"4px 10px",borderRight:"1px solid #1a1a1a"}}>
      <div style={{fontSize:8,letterSpacing:"0.1em"}} className="d">USYC</div>
      <div style={{fontSize:13,fontWeight:700}} className="b">{fmtK(act===1?bBal.usyc:lBal.usyc)}</div>
    </div>
    <div style={{flex:1,padding:"4px 10px"}}>
      <div style={{fontSize:8,letterSpacing:"0.1em"}} className="d">{act===1?"USTB":"RT VAL"}</div>
      <div style={{fontSize:13,fontWeight:700}} className="p">{act===1?fmtK(bBal.ustb):fmt(rtValue)}</div>
    </div>
  </div>
  {act===1?(
    <div style={{padding:"5px 8px",display:"flex",gap:4,borderBottom:"1px solid #1a1a1a",flexWrap:"wrap"}}>
      <Btn onClick={doPropose} active={!repo1Id&&isBorrower} disabled={!!repo1||!wallet} loading={loading==="propose"}>NEW REPO</Btn>
      <Btn onClick={doTopUp} disabled={repo1State!=="MARGIN_CALLED"||!isBorrower} warn={repo1State==="MARGIN_CALLED"&&isBorrower} loading={loading==="topup"}>TOP UP</Btn>
      <Btn onClick={doSubReq} disabled={repo1State!=="ACTIVE"||!isBorrower} loading={loading==="subreq"}>SUBSTITUTE</Btn>
      <Btn onClick={doSettle1} active={repo1State==="MATURED"&&isBorrower} disabled={repo1State!=="MATURED"||!isBorrower} loading={loading==="settle1"}>SETTLE</Btn>
    </div>
  ):(
    <div style={{padding:"5px 8px",display:"flex",gap:4,borderBottom:"1px solid #1a1a1a",flexWrap:"wrap"}}>
      <Btn onClick={doRehypo} active={repo1State==="ACTIVE"&&isLender&&!repo2Id} disabled={repo1State!=="ACTIVE"||!isLender||!!repo2Id} loading={loading==="rehypo"}>REHYPO RT#{repo1Id}</Btn>
      <Btn onClick={doSettle2} active={repo1State==="MATURED"&&isBorrower} disabled={repo1State!=="MATURED"||!isBorrower} loading={loading==="settle2"}>SETTLE #{repo1Id}</Btn>
    </div>
  )}
  {/* Blotter */}
  <div style={{flex:1,overflow:"auto"}}>
    {repo1?(
      <table>
        <thead><tr><th colSpan={4} style={{borderBottom:"1px solid #222"}}>REPO #{repo1Id} <span className={stc(repo1State)}>{repo1State}</span></th></tr></thead>
        <tbody>
          <tr><td className="d">NOTIONAL</td><td className="w">{fmt(repo1.cashAmount)}</td><td className="d">COL</td><td className="w">{fmtK(repo1.collateralAmount)} {colToken}</td></tr>
          <tr><td className="d">RATE</td><td className="w">{(Number(repo1.repoRateBps)/100).toFixed(2)}%</td><td className="d">HAIRCUT</td><td className="w">{(Number(repo1.haircutBps)/100).toFixed(2)}%</td></tr>
          <tr><td className="d">COL VAL</td><td className={Number(colValue)<Number(reqValue)?"r":"w"}>{fmt(colValue)}</td><td className="d">REQUIRED</td><td className="w">{fmt(reqValue)}</td></tr>
          {repo1.accumulatedYield>0n&&<tr><td className="d">MFG PMT</td><td className="g">-{fmt(repo1.accumulatedYield)}</td><td className="d" colSpan={2}>credit@settle</td></tr>}
          {settlement1&&(repo1State==="MATURED"||repo1State==="SETTLED")&&(
            <><tr><td colSpan={4} style={{borderTop:"1px double #333",color:"#555",fontWeight:700,fontSize:9}}>SETTLEMENT</td></tr>
            <tr><td className="d">INTEREST</td><td className="w">{fmt(settlement1.int)}</td><td className="d">MFG</td><td className="g">-{fmt(settlement1.mfg)}</td></tr>
            <tr><td className="d" style={{fontWeight:700}}>NET</td><td className="y" style={{fontWeight:700}}>{fmt(settlement1.net)}</td><td/><td/></tr></>
          )}
        </tbody>
      </table>
    ):<div style={{padding:30,textAlign:"center",color:"#1a1a1a"}}>NO POSITIONS</div>}
    {act===2&&repo2&&(
      <table style={{marginTop:8}}>
        <thead><tr><th colSpan={4} style={{borderBottom:"1px solid #333",color:"#86c"}}>REHYPO #{repo2Id} <span className={stc(repo2State)}>{repo2State}</span></th></tr></thead>
        <tbody>
          <tr><td className="d">BORROWED</td><td className="w">{fmt(repo2.cashAmount)}</td><td className="d">COL</td><td className="p">RT#{repo1Id}</td></tr>
          <tr><td className="d">RATE</td><td className="w">{(Number(repo2.repoRateBps)/100).toFixed(2)}%</td><td className="d">RT VAL</td><td className="w">{fmt(rtValue)}</td></tr>
          {repo2State==="MARGIN_CALLED"&&<tr><td colSpan={4} className="r">** CASCADE - COLLATERAL DESTROYED **</td></tr>}
          {repo2State==="DEFAULTED"&&<tr><td colSpan={4} className="r">** LIQUIDATED **</td></tr>}
        </tbody>
      </table>
    )}
  </div>
</div>

{/* PROTOCOL */}
<div style={{borderRight:"1px solid #1a1a1a",display:"flex",flexDirection:"column",overflow:"hidden",background:"#0c0c0c"}}>
  <div style={{padding:"4px 8px",background:"#111",borderBottom:"1px solid #1a1a1a",textAlign:"center"}}>
    <span style={{fontWeight:700,fontSize:9,color:"#555",letterSpacing:"0.15em"}}>PROTOCOL</span>
  </div>
  <div style={{padding:8,borderBottom:"1px solid #1a1a1a"}}>
    {act===1&&<>
    <div style={{fontSize:8,letterSpacing:"0.1em",marginBottom:4}} className="d">LOAD REPO</div>
    <div style={{display:"flex",gap:4,marginBottom:8}}>
      <input value={inputId} onChange={e=>setInputId(e.target.value)} style={{background:"#1a1a1a",border:"1px solid #2a2a2a",color:"#ccc",padding:"2px 6px",fontSize:10,width:40,fontFamily:"inherit"}}/>
      <Btn onClick={doLoad} disabled={!wallet}>LOAD</Btn>
    </div>
    <div style={{fontSize:8,letterSpacing:"0.1em",marginBottom:4}} className="d">MARKET SIM</div>
    <div style={{marginBottom:6}}><Btn onClick={doYield} disabled={repo1State!=="ACTIVE"||!wallet} loading={loading==="yield"} style={{width:"100%"}}>TRIGGER YIELD +520</Btn></div>
    <div style={{marginBottom:6}}>
      <div style={{display:"flex",gap:4}}>
        <Btn onClick={()=>doSetPrice(0.96)} disabled={!wallet} loading={loading==="price"} style={{flex:1}}>$0.96</Btn>
        <Btn onClick={()=>doSetPrice(1.00)} disabled={!wallet} loading={loading==="price"} style={{flex:1}}>$1.00</Btn>
      </div>
    </div>
    <div style={{marginBottom:6}}><Btn onClick={doCheckMargin} disabled={repo1State!=="ACTIVE"||!wallet} loading={loading==="margin"} style={{width:"100%"}}>CHECK MARGIN</Btn></div>
    <div style={{marginBottom:6}}><Btn onClick={doMaturity1} disabled={repo1State!=="ACTIVE"||!wallet} loading={loading==="maturity1"} style={{width:"100%"}}>ADVANCE TO MATURITY</Btn></div>
    {repo1State==="SETTLED"&&<div style={{marginTop:8}}><Btn onClick={doStartAct2} active style={{width:"100%",background:"#1a0a2a",color:"#86c",border:"1px solid #2a1a3a"}}>CONTINUE TO ACT 2 >></Btn></div>}
    </>}

    {act===2&&<>
    <div style={{fontSize:8,letterSpacing:"0.1em",marginBottom:4,color:"#86c"}}>ACT 2: REHYPOTHECATION</div>
    <div style={{marginBottom:6}}><Btn onClick={doMaturity2} disabled={repo1State!=="ACTIVE"||!wallet} loading={loading==="maturity2"} style={{width:"100%"}}>MATURE #{repo1Id}</Btn></div>
    <div style={{marginBottom:6}}><Btn onClick={doForceLiquidate} disabled={repo2State!=="MARGIN_CALLED"||!wallet} warn loading={loading==="forceLiq"} style={{width:"100%"}}>FORCE LIQUIDATE #{repo2Id}</Btn></div>
    <div style={{padding:"6px 0",borderTop:"1px solid #1a1a1a",marginTop:6}}>
      <div style={{fontSize:8,letterSpacing:"0.1em",marginBottom:3}} className="d">REHYPO CHAIN</div>
      <div style={{fontSize:9,color:"#86c",lineHeight:1.6}}>
        <div>105K USYC (real asset)</div>
        <div style={{color:"#333"}}>{"  |-> "}Repo #{repo1Id}: 100K USDC</div>
        <div style={{color:"#333"}}>{"     |-> "}RT#{repo1Id} (rehypo col)</div>
        <div style={{color:"#333"}}>{"        |-> "}Repo #{repo2Id}: 90K USDC</div>
        <div style={{color:"#a90",marginTop:4}}>Total: 190K from 105K (1.81x)</div>
      </div>
    </div>
    </>}
  </div>
  {/* ON-CHAIN */}
  {repo1&&<div style={{padding:"6px 8px",borderBottom:"1px solid #1a1a1a"}}>
    <div style={{fontSize:8,letterSpacing:"0.1em",marginBottom:3}} className="d">ON-CHAIN</div>
    <table style={{fontSize:8.5}}>
      <tbody>
        <tr><td className="d">COL VAL</td><td className={Number(colValue)<Number(reqValue)?"r":"g"}>{fmt(colValue)}</td></tr>
        <tr><td className="d">REQUIRED</td><td className="w">{fmt(reqValue)}</td></tr>
        <tr><td className="d">RT#{repo1Id}</td><td className="p">{short(rtHolder)}</td></tr>
        {repo2Id>0&&<tr><td className="d">REHYPO</td><td className={stc(repo2State)}>#{repo2Id} {repo2State}</td></tr>}
      </tbody>
    </table>
  </div>}
  {/* Events */}
  <div style={{flex:1,overflow:"auto",padding:"3px 6px"}}>
    <div style={{fontSize:8,letterSpacing:"0.1em",marginBottom:2}} className="d">EVENTS</div>
    {ef.map(e=>e.t?<Log key={e.id} time={e.ts} text={e.t} c={e.c}/>:null)}
    {ef.length===0&&<div style={{color:"#1a1a1a",fontSize:9,padding:15,textAlign:"center"}}>IDLE</div>}
  </div>
</div>

{/* RIGHT: LENDER (Act1) or CHARLIE (Act2) */}
<div style={{display:"flex",flexDirection:"column",overflow:"hidden"}}>
  <div style={{padding:"4px 10px",background:"#111",borderBottom:"1px solid #1a1a1a",display:"flex",justifyContent:"space-between"}}>
    <span style={{fontWeight:700,fontSize:10,color:act===1?"#58a":"#86c"}}>{act===1?"LENDER (Bravo)":"CHARLIE (TD_Charlie)"}</span>
    <span className="d" style={{fontSize:9}}>{short(act===1?lenderAddr:charlieAddr)}</span>
  </div>
  <div style={{display:"flex",borderBottom:"1px solid #1a1a1a"}}>
    <div style={{flex:1,padding:"4px 10px",borderRight:"1px solid #1a1a1a"}}>
      <div style={{fontSize:8,letterSpacing:"0.1em"}} className="d">USDC</div>
      <div style={{fontSize:13,fontWeight:700}} className="g">{fmt(act===1?lBal.usdc:cBal.usdc)}</div>
    </div>
    <div style={{flex:1,padding:"4px 10px",borderRight:"1px solid #1a1a1a"}}>
      <div style={{fontSize:8,letterSpacing:"0.1em"}} className="d">{act===1?"USYC":"RT HELD"}</div>
      <div style={{fontSize:13,fontWeight:700}} className={act===1?"b":"p"}>{act===1?fmtK(lBal.usyc):(rtHolder&&charlieAddr&&rtHolder.toLowerCase()===charlieAddr.toLowerCase()?`RT#${repo1Id}`:"--")}</div>
    </div>
    <div style={{flex:1,padding:"4px 10px"}}>
      <div style={{fontSize:8,letterSpacing:"0.1em"}} className="d">{act===1?"USTB":"RT VAL"}</div>
      <div style={{fontSize:13,fontWeight:700}} className="p">{act===1?fmtK(lBal.ustb):fmt(rtValue)}</div>
    </div>
  </div>
  {act===1?(
    <div style={{padding:"5px 8px",display:"flex",gap:4,borderBottom:"1px solid #1a1a1a",flexWrap:"wrap"}}>
      <Btn onClick={doAccept} active={repo1State==="PROPOSED"&&isLender} disabled={repo1State!=="PROPOSED"||!wallet||isBorrower} loading={loading==="accept"}>ACCEPT #{repo1Id||"?"}</Btn>
      <Btn onClick={doSubApprove} disabled={repo1State!=="ACTIVE"||!isLender} loading={loading==="subappr"}>APPROVE SUB</Btn>
    </div>
  ):(
    <div style={{padding:"5px 8px",display:"flex",gap:4,borderBottom:"1px solid #1a1a1a",flexWrap:"wrap"}}>
      <Btn onClick={doAcceptRehypo} active={repo2State==="PROPOSED"&&isCharlie} disabled={repo2State!=="PROPOSED"||!isCharlie} loading={loading==="acceptRehypo"}>ACCEPT REHYPO #{repo2Id||"?"}</Btn>
    </div>
  )}
  <div style={{flex:1,overflow:"auto"}}>
    {act===1&&repo1&&repo1State!=="PROPOSED"?(
      <table>
        <thead><tr><th colSpan={4} style={{borderBottom:"1px solid #222"}}>REPO #{repo1Id} <span className={stc(repo1State)}>{repo1State}</span></th></tr></thead>
        <tbody>
          <tr><td className="d">LENT</td><td className="y">{fmt(repo1.cashAmount)}</td><td className="d">COL</td><td className="w">{fmtK(repo1.collateralAmount)} {colToken}</td></tr>
          <tr><td className="d">RATE</td><td className="w">{(Number(repo1.repoRateBps)/100).toFixed(2)}%</td><td className="d">RT</td><td className="p">{short(rtHolder)}</td></tr>
          {settlement1&&repo1State==="SETTLED"&&<tr><td className="d">RECV</td><td className="g" style={{fontWeight:700}}>{fmt(settlement1.net)}</td><td className="d" colSpan={2}>settled</td></tr>}
        </tbody>
      </table>
    ):act===1&&repo1&&repo1State==="PROPOSED"?(
      <table>
        <thead><tr><th colSpan={4} style={{borderBottom:"1px solid #222"}}>INCOMING #{repo1Id} <span className="y">PROPOSED</span></th></tr></thead>
        <tbody>
          <tr><td className="d">FROM</td><td className="w">{short(borrowerAddr)}</td><td className="d">CASH</td><td className="w">{fmt(repo1.cashAmount)}</td></tr>
        </tbody>
      </table>
    ):act===2&&repo2?(
      <table>
        <thead><tr><th colSpan={4} style={{borderBottom:"1px solid #333",color:"#86c"}}>REHYPO #{repo2Id} <span className={stc(repo2State)}>{repo2State}</span></th></tr></thead>
        <tbody>
          <tr><td className="d">LENT</td><td className="y">{fmt(repo2.cashAmount)}</td><td className="d">COL</td><td className="p">RT#{repo1Id}</td></tr>
          <tr><td className="d">FROM</td><td className="w">{short(lenderAddr)}</td><td className="d">RATE</td><td className="w">{repo2?(Number(repo2.repoRateBps)/100).toFixed(2)+"%":"--"}</td></tr>
          {repo2State==="MARGIN_CALLED"&&<tr><td colSpan={4} className="r">** CASCADE - RT BURNED **</td></tr>}
          {repo2State==="DEFAULTED"&&<tr><td colSpan={4} className="r">** DEFAULTED - Charlie keeps cash, Lender loses RT **</td></tr>}
        </tbody>
      </table>
    ):<div style={{padding:30,textAlign:"center",color:"#1a1a1a"}}>NO INCOMING</div>}
  </div>
</div>

</div>
</div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
